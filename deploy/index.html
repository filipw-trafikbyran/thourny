<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Thourny</title>
	<link rel="stylesheet" href="style.css">
	<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyBJpgMBvbHBR2MenXr3U5buJh-oTCVc4HU",
	    authDomain: "thourny-85a69.firebaseapp.com",
	    databaseURL: "https://thourny-85a69.firebaseio.com",
	    projectId: "thourny-85a69",
	    storageBucket: "",
	    messagingSenderId: "1076714087397"
	  };
	  firebase.initializeApp(config);
	</script>
	<script>
		const database = firebase.database();
		var randbase;
		var increment = 1;
		var list;
		var ip;

		$( document ).ready(function() {
			$.getJSON("https://api.ipify.org/?format=json", function(e) {
			    ip = e.ip.replace(/\D/g,'');
			});
			database.ref('Players/').on('value', function(snapshot) {
				list = snapshot.val();
				randbase = list['order'];
				delete list['order'];
				display(list);
			});
			$('.matcher').on('click','.deltagare', function(e){
				newincrement = $('.increment').val();
				if(newincrement){
					increment = parseInt(newincrement);
				}
				update(e.target);
			});
			$('.title').on('click', function(e){
				display(list);
			});
			$('.settings').on('input','.user',function (){
				if($(this).val() == 'nays'){
					localStorage['thourneyAdmin'] = 'true';
					setupSetting();
				}
				else if($(this).val() == 'logg off'){
					localStorage['thourneyAdmin'] = 'false';
					setupSetting();
				} else if(ip){
					var target = 'Players/' + ip;
					var input = $(this).val();
					database.ref(target).once('value').then(function(snapshot) {
						console.log(snapshot.val().wins);
						database.ref(target).update({ 
							"name" : input,
							"wins" : snapshot.val().wins
						});
					});
					
				}
			})
			setupSetting();
		});

		function setupSetting(){
			$('.settings').html('<input type="text" class="user">');
			if(localStorage['thourneyAdmin'] == 'true'){
				$('.settings').append('<input type="number" class="increment" value="1">');
				$('.settings').append('<button onclick="reshuffle()">randomise</button>');
			}
		}

		function reshuffle(){
			database.ref('Players/order').set(Math.random());
		}
		function shuffleArray(array,randomizer) {
		    for (let i = array.length - 1; i > 0; i--) {
		        const j = Math.floor(randomizer * (i + 1));
		        [array[i], array[j]] = [array[j], array[i]];
		    }
		}
		
		function display(content){
			$('.matcher').html('');
			var matches = [];
			var m = 0;
			var p = 1;

			var keys = Object.keys(content);
			var len = keys.length;

			shuffleArray(keys,randbase);
			
			for (var i = 0; i < len; i++) {
				k = keys[i];
				// console.log(content[k]);
				var player = '<span class="deltagare" id="' + k + '" data-wins="' + content[k].wins + '">' + content[k].name +' [' + content[k].wins + ']</span>';
				if (p == 2) {
					matches[m] = matches[m] + player + '</li>';
					m++;
					p = 1;
				}
				else if(p == 1){
					matches[m] = '<li id="match-' + m + '" class="match">' + player + ' vs ';
					p++
				} 
			}

			// console.log(matches);

			// $.each(content, function(key, value){

			// 	var player = '<span class="deltagare" id="' + key + '" data-wins="' + value.wins + '">' + value.name +' [' + value.wins + ']</span>';
			// 	if (p == 2) {
			// 		matches[m] = matches[m] + player + '</li>';
			// 		m = m * randmulti;
			// 		p = 1;
			// 	}
			// 	else if(p == 1){
			// 		matches[m] = '<li id="match-' + m + '" class="match">' + player + ' vs ';
			// 		p++
			// 	} 
			// });

			$.each(matches, function(key, value){
				// console.log(key);
				$('.matcher').append(value);
			});
			// console.log(matches);
			$('.matcher').html()
		}
		function update(target){
			if(localStorage['thourneyAdmin'] == 'true'){
				database.ref('Players/' + $(target).attr('id')).update({ 
					"wins" : $(target).data('wins') + increment
				});
			}
		}
		
	</script>
</head>
<body>
	<h1 class="title">Thourny</h1>
	
	<!--  -->
	<ul class="matcher">
	</ul>
	<div class="settings">
		
	</div>
</body>
</html>